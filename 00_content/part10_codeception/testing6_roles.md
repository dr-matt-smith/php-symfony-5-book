

# Testing user role authentication

## Automating user login (project `codeception07`)

Codeception will run each `public` method in an acceptance `Cest` class in its testing. We can, however, write additional `private` methods in our testing classes, so simplify our code.

Let's add some helper methods to do things like logging in a user and confirming they can see / not see content or links.

The combination of data providers and helper methods will allow us to write and test complex features, without our testing methods growing too long.

## Testing login & link visibility with helper methods

For security role testing, for a website we might have a navbar link to `admin home` that is only visible to users logged in with `ROLE_ADMIN`:

```php
    {% if is_granted('ROLE_ADMIN') %}
    <li>
    <a href="{{ url('admin') }}">admin home</a>
    </li>
```

We can test this by logging in as a non-admin user, and asserting that we **cannot** see this link.

Here is a method to test this with a user who has `ROLE_USER` should ot 

```php
    /**
     * @example(email="user@user.com", password="user")
     */
    public function validUserRoleUserCannotSeeLinkToAdminHomePage(AcceptanceTester $I, Example $example)
    {
        // ARRANGE: login
        $email = $example['email'];
        $password = $example['password'];
        $this->helperLogin($I, $email, $password);
    
        // ASSERT: NOT authorised
        $this->dontSeeAdminHomeLink($I);
    }
```

This is a nice short test method, because it makes use of a `private` helper methods `login(...)` and `dontSeeAdminHomeLink(...)`. 

Here is `private` helper method `login(...)`. This method:

- logs in with provided `$email` and `$password` by visiting URL `/login`, filling in and submitting the login form, and asserting that we don't see either of the error messages for a bad login:

```php
    private function login(AcceptanceTester $I, $email, $password)
    {
        $I->amOnPage('/login');
        $I->expect('redirect to Login page');
        $I->seeCurrentUrlEquals('/login');
        $I->fillField('#inputEmail', $email);
        $I->fillField('#inputPassword', $password);
        $I->click('Login');

        // successful login
        $I->dontSee('Email could not be found.');
        $I->dontSee('Invalid credentials.');
    }
```

Note, we know the IDs of the email/password fields, and the text on the submit button from inspecting the HTML generated by the login form page. See Figure \ref{loginIds}.

![HTML form IDs for login form.\label{loginIds}](./03_figures/testing/10_login_ids.png)

Here is `private` helper method `dontSeeAdminHomeLink(...)`. This is a simple one, but illustrates another helper method.

```php
    private function dontSeeAdminHomeLink(AcceptanceTester $I)
    {
        $I->expect('NOT to see link to admin home');
        $I->dontSeeLink('admin home');
    }
```

We can also test logins for `ROLE_ADMIN` users, who should see the link to `admin home` after their login:

```php
    /**
     * @example(email="matt.smith@smith.com", password="smith")
     * @example(email="admin@admin.com", password="admin")
     */
    public function validAdminRoleUserCanSeeLinkToAdminHomePage(AcceptanceTester $I, Example $example)
    {
        // (1) arrange - login
        $email = $example['email'];
        $password = $example['password'];
        $this->login($I, $email, $password);

        // ASSERT: authorised
        $this->seeAdminHomeLink($I);
    }
```

This make use of the `login(...)` helper method again, and another helper method `seeAdminHomeLink(...)`:

```php
    private function seeAdminHomeLink(AcceptanceTester $I)
    {
        $I->expect('to see link to admin home');
        $I->seeLink('admin home');
    }
```

We can see the successful results of running these tests in Figure \ref{linkTests}.

![Test results for admin home link tests.\label{linkTests}](./03_figures/testing/11_adminHomeLinkTests.png)

## Testing access denied messages

Let's add another helper method, that tests we see an `access denied` message if after loggin in with a user whose does **NOT** have `ROLE_ADMIN` we try to access the `/admin` URL.

NOTE: If we try to visit `/admin` `**before** logging in, we'll first be re-directed to the login form. We should probably also test for that ...

Here is our public testing method, kept short by making use of `private` helper methods"

```php
    /**
     * @example(email="user@user.com", password="user")
     */
    public function validUserRoleUserGetsAccessDeniedMessageWhenTryVisitAdminHomePage(AcceptanceTester $I, Example $example)
    {
        // ARRANGE: login
        $email = $example['email'];
        $password = $example['password'];
        $this->login($I, $email, $password);

        // ASSERT: NOT authorised - error message when try to visit admin after login
        $this->visitAdminSeeAccessDeniedMessage($I);
    }
```

The `private` helper method `visitAdminSeeAccessDeniedMessage(...)` is as follows:

```php
    private function visitAdminSeeAccessDeniedMessage(AcceptanceTester $I)
    {
        $I->amOnPage('/admin');
        $I->expect('to see not authorised error');
        $I->see('access is denied for your request');

        // should NOT have access to admin page contents
        $I->dontSee('here is the secret code to the safe');
    }
```

Likewise, we can write a testing method that confirms after a `ROLE_ADMIN` login we can click the `admin home` link and see the secured secrets:

```php
    public function validAdminRoleUserCanVisitAdminHomePage(AcceptanceTester $I, Example $example)
    {
        // (1) arrange - login
        $email = $example['email'];
        $password = $example['password'];
        $this->login($I, $email, $password);

        // ASSERT: can access  secure pages
        $this->clickAdminHomeLinkAndSeeSecrets($I);
    }
```

Here is helper method `visitAdminSeeAccessDeniedMessage(...)`:

```php
    private function visitAdminSeeAccessDeniedMessage(AcceptanceTester $I)
    {
        $I->amOnPage('/admin');
        $I->expect('to see not authorised error');
        $I->see('access is denied for your request');

        // should NOT have access to admin page contents
        $I->dontSee('here is the secret code to the safe');
    }
```


We can see the successful results of running these tests in Figure \ref{postLinkTests}.

![Test results including what happens after click links.\label{postLinkTests}](./03_figures/testing/12_postLinkClickTestResults.png)

